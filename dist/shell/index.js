// @author.io/shell v1.8.18
// Copyright (c) 2022 Corey Butler
// Released under the MIT License.
import{Parser}from"@author.io/arg";import Table from"@author.io/table";export{default as Table}from"@author.io/table";function _classPrivateFieldGet(receiver,privateMap){return function _classApplyDescriptorGet(receiver,descriptor){return descriptor.get?descriptor.get.call(receiver):descriptor.value}(receiver,_classExtractFieldDescriptor(receiver,privateMap,"get"))}function _classPrivateFieldSet(receiver,privateMap,value){return function _classApplyDescriptorSet(receiver,descriptor,value){if(descriptor.set)descriptor.set.call(receiver,value);else{if(!descriptor.writable)throw new TypeError("attempted to set read only private field");descriptor.value=value}}(receiver,_classExtractFieldDescriptor(receiver,privateMap,"set"),value),value}function _classExtractFieldDescriptor(receiver,privateMap,action){if(!privateMap.has(receiver))throw new TypeError("attempted to "+action+" private field on non-instance");return privateMap.get(receiver)}class Middleware{constructor(){Object.defineProperties(this,{_data:{enumerable:!1,configurable:!1,value:[]},go:{enumerable:!1,configurable:!1,writable:!0,value:(...args)=>{args.pop().apply(this,args)}}})}get size(){return this._data.length}get data(){return this._data}use(method){const methodBody=method.toString();methodBody.indexOf("[native code]")<0&&this._data.push(methodBody),this.go=(stack=>(...args)=>{const next=args.pop();stack(...args,()=>{method.apply(this,[...args,next.bind(null,...args)])})})(this.go)}run(){const args=Array.from(arguments);0!==args.length&&"function"==typeof args[args.length-1]||args.push(()=>{}),this.go(...args)}}var _data=new WeakMap,_tableWidth=new WeakMap,_colAlign=new WeakMap,_colWidth=new WeakMap;class Formatter{constructor(data){_data.set(this,{writable:!0,value:null}),_tableWidth.set(this,{writable:!0,value:80}),_colAlign.set(this,{writable:!0,value:[]}),_colWidth.set(this,{writable:!0,value:["20%","15%","65%"]}),_classPrivateFieldSet(this,_data,data)}set width(value){_classPrivateFieldSet(this,_tableWidth,value<20?20:value)}set columnWidths(value){_classPrivateFieldSet(this,_colWidth,value)}set columnAlignment(value){_classPrivateFieldSet(this,_colAlign,value)}get usage(){const desc=_classPrivateFieldGet(this,_data).description.trim();if(_classPrivateFieldGet(this,_data)instanceof Command){const aliases=_classPrivateFieldGet(this,_data).aliases,out=[`${_classPrivateFieldGet(this,_data).commandroot}${aliases.length>0?"|"+aliases.join("|"):""}${_classPrivateFieldGet(this,_data).__flagConfig.size>0?" [FLAGS]":""}${_classPrivateFieldGet(this,_data).arguments.size>0?" "+Array.from(_classPrivateFieldGet(this,_data).arguments).map(i=>"<"+i+">").join(" "):""}`];return _classPrivateFieldGet(this,_data).__processors.size>0&&(out[out.length-1]+=(_classPrivateFieldGet(this,_data).arguments.size>0||_classPrivateFieldGet(this,_data).__flagConfig.size>0?" |":"")+" [COMMAND]"),desc.trim().length>0&&out!==desc&&out.push(new Table([[desc.trim().replace(/\n/gi,"\n  ")]],null,null,_classPrivateFieldGet(this,_tableWidth),[2,0,1,1]).output),out.join("\n")}return _classPrivateFieldGet(this,_data)instanceof Shell?`${_classPrivateFieldGet(this,_data).name}${_classPrivateFieldGet(this,_data).__processors.size>0?" [COMMAND]":""}\n${desc.trim().length>0?new Table([[desc.trim().replace(/\n/gi,"\n  ")]],null,null,_classPrivateFieldGet(this,_tableWidth),[2,0,1,1]).output:""}${_classPrivateFieldGet(this,_data).arguments.size>0?" "+Array.from(_classPrivateFieldGet(this,_data).arguments).map(i=>"["+i+"]").join(" "):""}\n`.trim():""}get subcommands(){const rows=Array.from(_classPrivateFieldGet(this,_data).__processors.values()).map(cmd=>[[cmd.name].concat(cmd.aliases).join("|"),cmd.description]),result=[];if(rows.length>0){const table=new Table(rows,_classPrivateFieldGet(this,_colAlign),["25%","75%"],_classPrivateFieldGet(this,_tableWidth),[2]);result.push("\nCommands:\n"),result.push(table.output)}return result.join("\n")}get help(){const usage=this.usage.trim();if(_classPrivateFieldGet(this,_data)instanceof Command){const flags=_classPrivateFieldGet(this,_data).__flagConfig,rows=[];flags.size>0&&flags.forEach((cfg,flag)=>{let aliases=Array.from(cfg.aliases||cfg.alias||[]);aliases=0===aliases.length?"":"["+aliases.map(a=>"-"+a).join(", ")+"]";let dsc=[cfg.description||""];cfg.hasOwnProperty("options")&&_classPrivateFieldGet(this,_data).describeOptions&&dsc.push(`Options: ${cfg.options.join(", ")}.`),cfg.hasOwnProperty("allowMultipleValues")&&!0===cfg.allowMultipleValues&&_classPrivateFieldGet(this,_data).describeMultipleValues&&dsc.push("Can be used multiple times."),cfg.hasOwnProperty("default")&&_classPrivateFieldGet(this,_data).describeDefault&&dsc.push(`(Default: ${cfg.default.toString()})`),cfg.hasOwnProperty("required")&&!0===cfg.required&&_classPrivateFieldGet(this,_data).describeRequired&&dsc.unshift("Required."),dsc=dsc.join(" ").trim(),rows.push(["--"+flag,aliases||"",dsc||""])});const table=new Table(rows,_classPrivateFieldGet(this,_colAlign),_classPrivateFieldGet(this,_colWidth),_classPrivateFieldGet(this,_tableWidth),[2,0,usage.length>0?1:0,0]);let subcommands="\n"+this.subcommands;return 0===subcommands.trim().length&&(subcommands=""),usage+(flags.size>0?"\n\nFlags:\n"+table.output:"")+subcommands}return _classPrivateFieldGet(this,_data)instanceof Shell?[usage,this.subcommands].join("\n"):""}}var _plugins=new WeakMap,_url=new WeakMap,_support=new WeakMap,_formattedDefaultHelp=new WeakMap,_description=new WeakMap,_customUsage=new WeakMap,_customHelp=new WeakMap,_arguments=new WeakMap,_autohelp=new WeakMap,_processors=new WeakMap,_commands=new WeakMap,_width=new WeakMap,_name=new WeakMap,_middleware=new WeakMap,_trailer=new WeakMap,_commonflags=new WeakMap,_display=new WeakMap,_hasCustomDefaultHandler=new WeakMap,_defaultHandler=new WeakMap;class Base{constructor(cfg={}){if(_plugins.set(this,{writable:!0,value:{}}),_url.set(this,{writable:!0,value:null}),_support.set(this,{writable:!0,value:null}),_formattedDefaultHelp.set(this,{writable:!0,value:void 0}),_description.set(this,{writable:!0,value:void 0}),_customUsage.set(this,{writable:!0,value:void 0}),_customHelp.set(this,{writable:!0,value:void 0}),_arguments.set(this,{writable:!0,value:new Set}),_autohelp.set(this,{writable:!0,value:!0}),_processors.set(this,{writable:!0,value:new Map}),_commands.set(this,{writable:!0,value:new Map}),_width.set(this,{writable:!0,value:80}),_name.set(this,{writable:!0,value:"Unknown"}),_middleware.set(this,{writable:!0,value:new Middleware}),_trailer.set(this,{writable:!0,value:new Middleware}),_commonflags.set(this,{writable:!0,value:{}}),_display.set(this,{writable:!0,value:{Default:null,Options:null,MultipleValues:null,Required:null}}),_hasCustomDefaultHandler.set(this,{writable:!0,value:!1}),_defaultHandler.set(this,{writable:!0,value:function(meta){return null!==this.parent&&this.parent.hasCustomDefaultHandler?this.parent.defaultHandler(...arguments):this.shell&&null!==this.shell&&this.shell.hasCustomDefaultHandler?this.shell.defaultHandler(...arguments):void(_classPrivateFieldGet(this,_autohelp)&&console.log(this.help))}}),"object"!=typeof cfg)throw new Error("Invalid command configuration. Expected an object.");if(!cfg.hasOwnProperty("name"))throw new Error('Invalid command configuration. A "name" attribute is required.');if(cfg.hasOwnProperty("help")&&_classPrivateFieldSet(this,_customHelp,cfg.help),cfg.hasOwnProperty("usage")&&_classPrivateFieldSet(this,_customUsage,cfg.usage),cfg.hasOwnProperty("disablehelp")&&!cfg.hasOwnProperty("disableHelp")&&(cfg.disableHelp=cfg.disablehelp),cfg.hasOwnProperty("disableHelp")&&!0===cfg.disableHelp&&_classPrivateFieldSet(this,_autohelp,!1),"function"!=typeof cfg.help&&"string"!=typeof cfg.help||(this.help=cfg.help),"function"!=typeof cfg.usage&&"string"!=typeof cfg.usage||(this.usage=cfg.usage),cfg.hasOwnProperty("defaultHandler")&&cfg.defaultHandler.toString()!==_classPrivateFieldGet(this,_defaultHandler).toString()&&(this.defaultHandler=cfg.defaultHandler),"string"==typeof cfg.arguments&&(cfg.arguments=cfg.arguments.split(/\s+|\t+|\,+|\;+/).map(arg=>arg.trim())),Array.isArray(cfg.arguments)&&_classPrivateFieldSet(this,_arguments,new Set(cfg.arguments)),"string"==typeof cfg.url&&_classPrivateFieldSet(this,_url,cfg.url),"string"==typeof cfg.support&&_classPrivateFieldSet(this,_support,cfg.support),_classPrivateFieldSet(this,_name,(cfg.name||"unknown").trim().split(/\s+/)[0]),_classPrivateFieldSet(this,_description,cfg.description||null),Array.isArray(cfg.commands))cfg.commands.forEach(cmd=>this.add(cmd));else if("object"==typeof cfg.commands)for(const key in cfg.commands){const data=cfg.commands[key];data.name=key,this.add(data)}if(cfg.hasOwnProperty("middleware")&&(console.warn('The "middleware" attribute has been replaced with the "use" attribute.'),cfg.use=cfg.middleware,delete cfg.middleware),cfg.hasOwnProperty("commonflag")||(cfg.hasOwnProperty("commonFlag")?cfg.commonflag=cfg.commonFlag:cfg.hasOwnProperty("commonflags")?cfg.commonflag=cfg.commonflags:cfg.hasOwnProperty("commonFlag")?cfg.commonflag=cfg.commonFlag:cfg.hasOwnProperty("commonFlags")&&(cfg.commonflag=cfg.commonFlags)),cfg.hasOwnProperty("commonflag")&&"object"!=typeof cfg.commonflag)throw new Error('The "commonflag" configuration attribute must be an object.');"object"==typeof cfg.plugins&&_classPrivateFieldSet(this,_plugins,cfg.plugins),Object.defineProperties(this,{__processors:{enumerable:!1,get(){return _classPrivateFieldGet(this,_processors)}},__commands:{enumerable:!1,get(){return _classPrivateFieldGet(this,_commands)}},__width:{enumerable:!1,get(){return _classPrivateFieldGet(this,_width)},set(v){_classPrivateFieldSet(this,_width,v||80)}},__commonflags:{enumerable:!1,get(){return _classPrivateFieldGet(this,_commonflags)},set(value){_classPrivateFieldSet(this,_commonflags,value)}},arguments:{enumerable:!1,get(){return _classPrivateFieldGet(this,_arguments)}},initializeMiddleware:{enumerable:!1,configurable:!1,writable:!1,value:code=>{if("string"==typeof code)this.use(Function("return "+code)());else{if("function"!=typeof code)throw new Error("Invalid middleware: "+code.toString());this.use(code)}}},initializeTrailer:{enumerable:!1,configurable:!1,writable:!1,value:code=>{if("string"==typeof code)this.trailer(Function("return "+code)());else{if("function"!=typeof code)throw new Error("Invalid trailer: "+code.toString());this.trailer(code)}}},initializeHelpAnnotations:{enumerable:!1,configurable:!1,writable:!1,value:cfg=>{cfg.hasOwnProperty("describeDefault")&&"boolean"==typeof cfg.describeDefault&&(_classPrivateFieldGet(this,_display).Default=cfg.describeDefault),cfg.hasOwnProperty("describeOptions")&&"boolean"==typeof cfg.describeOptions&&(_classPrivateFieldGet(this,_display).Options=cfg.describeOptions),cfg.hasOwnProperty("describeMultipleValues")&&"boolean"==typeof cfg.describeMultipleValues&&(_classPrivateFieldGet(this,_display).MultipleValues=cfg.describeMultipleValues),cfg.hasOwnProperty("describeRequired")&&"boolean"==typeof cfg.describeRequired&&(_classPrivateFieldGet(this,_display).Required=cfg.describeRequired)}}}),this.updateHelp()}get plugins(){return _classPrivateFieldGet(this,_plugins)}get name(){return _classPrivateFieldGet(this,_name)||"Unknown"}get description(){return _classPrivateFieldGet(this,_description)||this.usage||""}get url(){return this.URL}get URL(){const uri=(_classPrivateFieldGet(this,_url)||"").trim();if(0===uri.length){if(this.hasOwnProperty("parent"))return this.parent.URL;if(this instanceof Command)return this.shell.URL}return uri}get support(){const support=(_classPrivateFieldGet(this,_support)||"").trim();if(0===support.length){if(this.hasOwnProperty("parent"))return this.parent.support;if(this instanceof Command)return this.shell.support}return support}get autohelp(){return _classPrivateFieldGet(this,_autohelp)}set autohelp(value){"boolean"==typeof value&&(_classPrivateFieldSet(this,_autohelp,value),_classPrivateFieldGet(this,_processors).forEach(cmd=>{cmd.autohelp=value}))}updateHelp(){_classPrivateFieldSet(this,_formattedDefaultHelp,new Formatter(this)),_classPrivateFieldGet(this,_formattedDefaultHelp).width=_classPrivateFieldGet(this,_width)}describeHelp(attr,prop){if(null!==_classPrivateFieldGet(this,_display)[prop])return _classPrivateFieldGet(this,_display)[prop];if(this instanceof Command){if(this.shell&&null!==this.shell&&null!==this.shell[attr])return this.shell[attr];if(null!==this.parent)return this.parent[attr]}return!0}get describeDefault(){return this.describeHelp("describeDefault","Default")}get describeOptions(){return this.describeHelp("describeOptions","Options")}get describeMultipleValues(){return this.describeHelp("describeMultipleValues","MultipleValues")}get describeRequired(){return this.describeHelp("describeRequired","Required")}get usage(){return null!==_classPrivateFieldGet(this,_customUsage)?"function"==typeof _classPrivateFieldGet(this,_customUsage)?_classPrivateFieldGet(this,_customUsage).call(this):_classPrivateFieldGet(this,_customUsage):_classPrivateFieldGet(this,_formattedDefaultHelp).usage}set usage(value){"string"==typeof value&&0===value.trim().length&&(value=null),_classPrivateFieldSet(this,_customUsage,value),this.updateHelp()}get help(){return _classPrivateFieldGet(this,_customHelp)?"function"==typeof _classPrivateFieldGet(this,_customHelp)?_classPrivateFieldGet(this,_customHelp).call(this,this):_classPrivateFieldGet(this,_customHelp):this.autohelp?_classPrivateFieldGet(this,_formattedDefaultHelp).help:""}set help(value){"string"==typeof value&&0===value.trim().length&&(value=null),_classPrivateFieldSet(this,_customHelp,value),this.updateHelp()}set defaultHandler(value){if("function"!=typeof value)throw new Error(`Invalid default method (must be a function, not "${typeof value}").`);_classPrivateFieldSet(this,_defaultHandler,value),_classPrivateFieldSet(this,_hasCustomDefaultHandler,!0),_classPrivateFieldGet(this,_processors).forEach(cmd=>{cmd.defaultProcessor=value})}get defaultHandler(){return _classPrivateFieldGet(this,_defaultHandler)}get hasCustomDefaultHandler(){return _classPrivateFieldGet(this,_hasCustomDefaultHandler)}get data(){const commands={};return Array.from(_classPrivateFieldGet(this,_processors).values()).forEach(cmd=>{const data=cmd.data,name=data.name;delete data.name,commands[name]=data}),commands}get middleware(){return _classPrivateFieldGet(this,_middleware)}get trailers(){return _classPrivateFieldGet(this,_trailer)}get commands(){return _classPrivateFieldGet(this,_processors)}get commandlist(){const list=new Set;return this.commands.forEach(cmd=>{list.add(cmd.name),cmd.commandlist.forEach(subcmd=>list.add(`${cmd.name} ${subcmd}`))}),Array.from(list).sort()}getCommand(name=null){if(!name)return null;const names=name.split(/\s+/i);let cmd=_classPrivateFieldGet(this,_commands).get(names.shift());if(cmd){cmd=_classPrivateFieldGet(this,_processors).get(cmd);for(const nm of names)cmd=cmd.getCommand(nm)}return cmd instanceof Command?cmd:null}remove(){for(const cmd of arguments)if("symbol"==typeof cmd&&(_classPrivateFieldGet(this,_processors).delete(cmd),_classPrivateFieldGet(this,_commands).forEach(oid=>oid===cmd&&_classPrivateFieldGet(this,_commands).delete(oid))),"string"==typeof cmd){const OID=_classPrivateFieldGet(this,_commands).get(cmd);OID&&this.remove(OID)}}use(){for(const arg of arguments){if("function"!=typeof arg)throw new Error(`All "use()" arguments must be valid functions.\n${arg.toString().substring(0,50)} ${arg.toString().length>50?"...":""}`);_classPrivateFieldGet(this,_middleware).use(arg)}_classPrivateFieldGet(this,_processors).forEach(subCmd=>subCmd.use(...arguments))}trailer(){_classPrivateFieldSet(this,_trailer,_classPrivateFieldGet(this,_trailer)||new Middleware);for(const arg of arguments){if("function"!=typeof arg)throw new Error(`All "trailer()" arguments must be valid functions.\n${arg.toString().substring(0,50)} ${arg.toString().length>50?"...":""}`);_classPrivateFieldGet(this,_trailer).use(arg)}_classPrivateFieldGet(this,_processors).forEach(subCmd=>subCmd.trailer(...arguments))}add(){for(let command of arguments){if(!(command instanceof Command)){if("object"!=typeof command)throw new Error('Invalid argument. Only "Command" instances may be added to the processor.');command=new Command(command)}command.autohelp=this.autohelp,this instanceof Shell?command.shell=this:this instanceof Command&&(command.parent=this),_classPrivateFieldGet(this,_processors).set(command.OID,command),_classPrivateFieldGet(this,_commands).set(command.name,command.OID),command.aliases.forEach(alias=>_classPrivateFieldGet(this,_commands).set(alias,command.OID))}}}const FLAG_PATTERN=/((?:"[^"\\]*(?:\\[\S\s][^"\\]*)*"|'[^'\\]*(?:\\[\S\s][^'\\]*)*'|\/[^\/\\]*(?:\\[\S\s][^\/\\]*)*\/[gimy]*(?=\s|$)|(?:\\\s|\S))+)(?=\s|$)/g,METHOD_PATTERN=/^([\w]+\s?)\(.*\)\s?{/i,STRIP_QUOTE_PATTERN=/"([^"\\]*(\\.[^"\\]*)*)"|\'([^\'\\]*(\\.[^\'\\]*)*)\'/gi,COMMAND_PATTERN=/^(\w+)\s+([\s\S]+)?/i;Object.freeze({SUBCOMMAND_PATTERN:/^([^"'][\S\b]+)[\s+]?([^-].*)$/i,FLAG_PATTERN:FLAG_PATTERN,METHOD_PATTERN:METHOD_PATTERN,STRIP_QUOTE_PATTERN:STRIP_QUOTE_PATTERN,COMMAND_PATTERN:COMMAND_PATTERN});var _middlewareGroups=new WeakMap,_history=new WeakMap,_maxHistoryItems=new WeakMap,_version=new WeakMap,_cursor=new WeakMap,_tabWidth=new WeakMap,_runtime=new WeakMap;class Shell extends Base{constructor(cfg={maxhistory:100}){super(cfg),_middlewareGroups.set(this,{writable:!0,value:new Map}),_history.set(this,{writable:!0,value:[]}),_maxHistoryItems.set(this,{writable:!0,value:void 0}),_version.set(this,{writable:!0,value:void 0}),_cursor.set(this,{writable:!0,value:0}),_tabWidth.set(this,{writable:!0,value:void 0}),_runtime.set(this,{writable:!0,value:globalThis.hasOwnProperty("window")?"browser":globalThis.hasOwnProperty("process")&&globalThis.process.release&&globalThis.process.release.name?globalThis.process.release.name:"unknown"}),this.initializeHelpAnnotations(cfg),this.__commonflags=cfg.commonflags||{},cfg.hasOwnProperty("use")&&Array.isArray(cfg.use)&&cfg.use.forEach(code=>this.initializeMiddleware(code)),cfg.hasOwnProperty("trailer")&&Array.isArray(cfg.trailer)&&cfg.trailer.forEach(code=>this.initializeTrailer(code)),_classPrivateFieldSet(this,_version,cfg.version||"1.0.0"),_classPrivateFieldSet(this,_maxHistoryItems,cfg.maxhistory||cfg.maxHistoryItems||100),_classPrivateFieldSet(this,_tabWidth,cfg.hasOwnProperty("tabWidth")?cfg.tabWidth:4),globalThis[Symbol("SHELL_INTEGRATIONS")]=this}get data(){const commands=super.data;return{name:this.name,description:this.description,version:this.version,commands:commands,use:this.middleware.data,trailer:this.trailers.data,help:this.help,usage:this.usage,defaultHandler:this.defaultHandler.toString(),disableHelp:!this.autohelp,runtime:_classPrivateFieldGet(this,_runtime),maxHistoryItems:_classPrivateFieldGet(this,_maxHistoryItems)}}get version(){return _classPrivateFieldGet(this,_version)||"Unknown"}set tableWidth(value){this.__width=value}get tableWidth(){return this.__width}history(count=null){return 0===_classPrivateFieldGet(this,_history).length?[]:null===count?_classPrivateFieldGet(this,_history).slice():_classPrivateFieldGet(this,_history).slice(0,count)}priorCommand(count=0){return 0===_classPrivateFieldGet(this,_history).length?null:count<0?this.nextCommand(Math.abs(count)):(count%=_classPrivateFieldGet(this,_history).length,_classPrivateFieldSet(this,_cursor,_classPrivateFieldGet(this,_cursor)+count),_classPrivateFieldGet(this,_cursor)>=_classPrivateFieldGet(this,_history).length&&_classPrivateFieldSet(this,_cursor,_classPrivateFieldGet(this,_history).length-1),_classPrivateFieldGet(this,_history)[_classPrivateFieldGet(this,_cursor)].input)}nextCommand(count=1){return 0===_classPrivateFieldGet(this,_history).length?null:count<0?this.priorCommand(Math.abs(count)):(count%=_classPrivateFieldGet(this,_history).length,_classPrivateFieldSet(this,_cursor,_classPrivateFieldGet(this,_cursor)-count),_classPrivateFieldGet(this,_cursor)<0?void _classPrivateFieldSet(this,_cursor,0):_classPrivateFieldGet(this,_history)[_classPrivateFieldGet(this,_cursor)].input)}useWith(commands){if(arguments.length<2)throw new Error("useWith(['command', 'command'], fn) requires two or more arguments.");if(commands="string"==typeof commands?commands.split(/\s+/):commands,!Array.isArray(commands)||commands.filter(c=>"string"!=typeof c).length>0)throw new Error("The first argument of useWith must be a string or array of strings. Received "+typeof commands);const fns=Array.from(arguments).slice(1);commands.forEach(cmd=>_classPrivateFieldGet(this,_middlewareGroups).set(cmd.trim(),(_classPrivateFieldGet(this,_middlewareGroups).get(cmd.trim())||[]).concat(fns)))}useExcept(commands){if(arguments.length<2)throw new Error("useExcept(['command', 'command'], fn) requires two or more arguments.");if(commands="string"==typeof commands?commands.split(/\s+/):commands,!Array.isArray(commands)||commands.filter(c=>"string"!=typeof c).length>0)throw new Error("The first argument of useExcept must be a string or array of strings. Received "+typeof commands);const fns=Array.from(arguments).slice(1),all=new Set(this.commandlist.map(i=>i.toLowerCase()));commands.forEach(cmd=>{all.delete(cmd);for(const c of all)0===c.indexOf(cmd)&&all.delete(c)}),this.useWith(Array.from(all),...fns)}async exec(input,callback){Array.isArray(input)&&(input=input.map(i=>i.indexOf(" ")>=0&&!/^[\"\'].+ [\"\']$/.test(i)?`"${i}"`:i).join(" ")),_classPrivateFieldGet(this,_history).unshift({input:input,time:(new Date).toLocaleString()}),_classPrivateFieldGet(this,_history).length>_classPrivateFieldGet(this,_maxHistoryItems)&&_classPrivateFieldGet(this,_history).pop();let parsed=COMMAND_PATTERN.exec(input+" ");if(null===parsed)return-1!==input.indexOf("version")||-1!==input.indexOf("-v")?console.log(this.version):-1!==input.indexOf("help")?console.log(this.help):Command.stderr(this.help);parsed=parsed.filter(item=>void 0!==item);const cmd=parsed[1],args=parsed.length>2?parsed[2]:"",action=this.__commands.get(cmd);if(!action)return"version"===cmd.toLowerCase()?console.log(this.version):Command.stderr(this.help);const processor=this.__processors.get(action);if(!processor)return Command.stderr("Command not found.");const term=processor.getTerminalCommand(args);return await Command.reply(await term.command.run(term.arguments,callback))}getCommandMiddleware(cmd){const results=[];return cmd.split(/\s+/).forEach((c,i,a)=>{const r=_classPrivateFieldGet(this,_middlewareGroups).get(a.slice(0,i+1).join(" "));r&&results.push(r.flat(1/0))}),results.flat(1/0)}clearHistory(){_classPrivateFieldSet(this,_history,[])}clear(){_classPrivateFieldSet(this,_history,[]),console.clear()}}var _pattern=new WeakMap,_oid=new WeakMap,_aliases=new WeakMap,_fn=new WeakMap,_flagConfig=new WeakMap,_parent=new WeakMap,_shell=new WeakMap;class Command extends Base{constructor(cfg={}){if(cfg.hasOwnProperty("handler")&&("string"==typeof cfg.handler&&(cfg.handler=Function("return ("+cfg.handler.replace("function anonymous","function")+").call(this)").call(globalThis)),"function"!=typeof cfg.handler))throw new Error('Invalid command configuration. A "handler" function is required.');if(super(cfg),_pattern.set(this,{writable:!0,value:void 0}),_oid.set(this,{writable:!0,value:void 0}),_aliases.set(this,{writable:!0,value:new Set}),_fn.set(this,{writable:!0,value:void 0}),_flagConfig.set(this,{writable:!0,value:{}}),_parent.set(this,{writable:!0,value:null}),_shell.set(this,{writable:!0,value:null}),cfg.hasOwnProperty("use")&&Array.isArray(cfg.use)&&cfg.use.forEach(code=>this.initializeMiddleware(code)),cfg.hasOwnProperty("trailer")&&Array.isArray(cfg.trailer)&&cfg.trailer.forEach(code=>this.initializeTrailer(code)),this.initializeHelpAnnotations(cfg),_classPrivateFieldSet(this,_fn,cfg.handler),_classPrivateFieldSet(this,_oid,Symbol(cfg.name||cfg.usage||cfg.pattern||"command")),_classPrivateFieldSet(this,_pattern,cfg.pattern||/[\s\S]+/i),cfg.alias&&!cfg.aliases&&(cfg.aliases="string"==typeof cfg.alias?[cfg.alias]:Array.isArray(cfg.alias)?cfg.alias:Array.from(cfg.alias),delete cfg.alias),cfg.aliases){if(!Array.isArray(cfg.aliases))throw new Error("The alias property only accepts an array.");_classPrivateFieldSet(this,_aliases,new Set(cfg.aliases))}if(cfg.flags){if("object"!=typeof cfg.flags)throw new Error(`Invalid flag configuration (expected and object, received ${typeof cfg.flags}).`);for(const[key,value]of Object.entries(cfg.flags))if(value.hasOwnProperty("alias")){if(value.aliases=value.aliases||[],Array.isArray(value.alias)){if(value.aliases=Array.from(new Set(...value.aliases,...value.alias)),value.aliases.filter(a=>"string"!=typeof a)>0)throw new Error(`${key} flag aliases must be strings. Type failure on: ${value.aliases.filter(a=>"string"!=typeof a).join(", ")}.`)}else{if("string"!=typeof value.alias)throw new Error(`Aliases must be strings, not ${typeof value.alias} (${key} flag).`);value.aliases.push(value.alias)}delete value.alias}_classPrivateFieldSet(this,_flagConfig,cfg.flags)}Array.isArray(cfg.subcommands)&&this.add(...cfg.subcommands);const attributes=new Set(["commands","subcommands","plugins","defaultHandler","disableHelp","describeDefault","describeOptions","describeMultipleValues","describeRequired","flags","alias","aliases","description","help","usage","pattern","name","handler","middleware","use","arguments","commonflag","commonflags","trailer","url","support"]),unrecognized=Object.keys(cfg).filter(attribute=>!attributes.has(attribute));if(unrecognized.length>0)throw new Error("Unrecognized configuration attribute(s): "+unrecognized.join(", "));const ignoreFlags=commonFlags=>{if(commonFlags.ignore&&(Array.isArray(commonFlags.ignore)||"string"==typeof commonFlags.ignore)){const ignore=new Set(Array.isArray(commonFlags.ignore)?commonFlags.ignore:[commonFlags.ignore]),root=this.commandroot.replace(new RegExp(`^${this.shell.name}\\s+`,"i"),"");for(const cmd of ignore)if(root.startsWith(cmd)){commonFlags={};break}}return commonFlags};Object.defineProperties(this,{__commonFlags:{enumerable:!1,get(){let flags=ignoreFlags(this.__commonflags);null!==this.parent&&(flags=Object.assign(flags,this.parent.__commonFlags));const result=Object.assign({},null!==this.shell?ignoreFlags(this.shell.__commonflags):{},flags);return(Array.isArray(result.ignore)||"string"==typeof result.ignore)&&delete result.ignore,result}},__flagConfig:{enumerable:!1,get(){const flags=new Map(Object.entries(Object.assign(this.__commonFlags,_classPrivateFieldGet(this,_flagConfig)||{})));return flags.delete("help"),flags}},getTerminalCommand:{enumerable:!1,configurable:!1,writable:!1,value:input=>{const args=input.trim().split(/\t+|\s+/);let cmd=this;for(;args.length>0;){const arg=args[0],subcmd=cmd.getCommand(arg);if(!subcmd)break;cmd=subcmd,args.shift()}return{command:cmd,arguments:args.join(" ")}}}}),this.__commonflags=cfg.commonflags||{},this.__width=null===this.shell?80:this.shell.tableWidth||80,this.updateHelp()}get data(){const commands=super.data;let handler=(_classPrivateFieldGet(this,_fn)||this.defaultHandler).toString();METHOD_PATTERN.test(handler)&&(handler=handler.replace(METHOD_PATTERN.exec(handler)[1],"function "));const flags=Object.assign(this.__commonFlags,_classPrivateFieldGet(this,_flagConfig)||{});for(const[key,value]of Object.entries(flags))value.aliases=value.aliases||[],value.hasOwnProperty("alias")&&value.aliases.indexOf(value.alias)<0&&value.aliases.push(value.alias),delete value.alias;Object.keys(flags).forEach(name=>{flags[name]=Object.assign(this.getFlagConfiguration(name),flags[name])});const data={name:this.name,description:this.description,help:this.help,usage:this.usage,aliases:Array.from(_classPrivateFieldGet(this,_aliases)),flags:flags,handler:handler,commands:commands,disableHelp:!this.autohelp,use:this.middleware.data,trailer:this.trailers.data};for(const[key,value]of Object.entries(data.flags))delete value.alias;return data}set parent(cmd){if(!(cmd instanceof Command))throw new Error(`Cannot set parent of "${this.name}" command to anything other than another command. To make this command a direct descendent of the main shell, use the shell attribute instead.`);_classPrivateFieldSet(this,_parent,cmd)}get parent(){return _classPrivateFieldGet(this,_parent)}set shell(shell){if(!shell)throw new Error(`Cannot set shell of ${this.name} command to a non-Shell object.`);if(!(shell instanceof Shell))throw new Error(`Expected a Shell object, received a "${typeof shell}" object.`);_classPrivateFieldSet(this,_shell,shell),this.__width=null===this.shell?80:shell.tableWidth}get shell(){return _classPrivateFieldGet(this,_shell)?_classPrivateFieldGet(this,_shell):_classPrivateFieldGet(this,_parent)?_classPrivateFieldGet(this,_parent).shell:null}get plugins(){return Object.assign({},this.shell.plugins,this.parent?this.parent.plugins:{},super.plugins)}get commandroot(){return _classPrivateFieldGet(this,_parent)?`${_classPrivateFieldGet(this,_parent).commandroot} ${this.name}`.trim():_classPrivateFieldGet(this,_shell)?`${_classPrivateFieldGet(this,_shell).name} ${this.name}`.trim():this.name}set aliases(value){if(value){if("object"==typeof value)switch(value.constructor.name.toLowerCase()){case"map":value=Array.from(value.keys());break;case"set":value=Array.from(value);break;case"object":value=Object.keys(value).filter(item=>"string"==typeof item);break;case"array":break;case"string":value=value.split(/\s+/)[0];break;default:throw new Error("Invalid alias value. Use an array of strings.")}_classPrivateFieldSet(this,_aliases,Array.from(new Set(value)))}else _classPrivateFieldSet(this,_aliases,[])}get aliases(){return Array.from(_classPrivateFieldGet(this,_aliases))||[]}get OID(){return _classPrivateFieldGet(this,_oid)}addFlag(name,cfg){if("string"!=typeof name){if(!cfg.hasOwnProperty("name"))throw new Error("Invalid flag name (should be a string).");name=cfg.name}_classPrivateFieldGet(this,_flagConfig)[name]=cfg}removeFlag(name){delete _classPrivateFieldGet(this,_flagConfig)[name]}getFlagConfiguration(name){let flag=this.__flagConfig.get(name);if(!flag){for(const[f,cfg]of this.__flagConfig)if(cfg.aliases&&cfg.aliases.indexOf(name)>=0||cfg.alias&&cfg.alias===flag){flag=cfg;break}if(!flag)return null}return{description:flag.description,required:!!flag.hasOwnProperty("required")&&flag.required,aliases:flag.aliases||[flag.alias].filter(i=>null!==i),type:void 0===flag.type?"string":"string"==typeof flag.type?flag.type:flag.type.name.toLowerCase(),options:flag.hasOwnProperty("options")?flag.options:null,allowMultipleValues:!!flag.hasOwnProperty("allowMultipleValues")&&flag.allowMultipleValues}}supportsFlag(name){return _classPrivateFieldGet(this,_flagConfig).hasOwnProperty(name)}deepParse(input){const meta=this.parse(input);if(0===this.__commands.size)return meta;if(0===meta.input.trim().length)return meta;const args=meta.input.split(/\s+/),subcmd=this.__commands.get(args.shift());return subcmd?this.__processors.get(subcmd).deepParse(args.join(" ")):meta}parse(input){const data={command:this.name,input:input.trim()},flagConfig=Object.assign(this.__commonFlags,_classPrivateFieldGet(this,_flagConfig)||{});flagConfig.hasOwnProperty("help")||(flagConfig.help={description:`Display ${this.name} help.`,default:!1,type:"boolean"});const flags=Array.from(FLAG_PATTERN[Symbol.matchAll](input),x=>x[0]),parser=new Parser(flags,flagConfig),pdata=parser.data,recognized={};if(parser.recognizedFlags.forEach(flag=>{recognized[flag]=pdata[flag]}),parser.unrecognizedFlags.forEach(arg=>delete recognized[arg]),data.flags={recognized:recognized,unrecognized:parser.unrecognizedFlags},data.valid=parser.valid,data.violations=parser.violations,data.parsed={},Object.keys(pdata.flagSource).length>0)for(const[key,src]of Object.entries(pdata.flagSource))data.parsed[src.name]=src.inputName;data.help={requested:recognized.help},recognized.help&&(data.help.message=this.help);const args=Array.from(this.arguments);return Object.defineProperties(data,{flag:{enumerable:!0,configurable:!1,writable:!1,value:name=>{try{return"number"==typeof name?Array.from(parser.unrecognizedFlags)[name]:data.flags.recognized.hasOwnProperty(pdata.flagSource[name].name)?data.flags.recognized[pdata.flagSource[name].name]:pdata.flagSource[name].value}catch(e){return this.arguments.has(name)?Array.from(parser.unrecognizedFlags)[args.indexOf(name)]:void 0}}},command:{enumerable:!0,get:()=>this},shell:{enumerable:!0,get:()=>this.shell},data:{enumerable:!0,get(){const uf=parser.unrecognizedFlags,result=Object.assign({},recognized);return delete result.help,args.forEach((name,i)=>{const value=uf[i];let normalizedValue=Object.keys(pdata).filter(key=>key.toLowerCase()===value);normalizedValue=normalizedValue.length>0?normalizedValue.pop():value,void 0!==normalizedValue&&(normalizedValue=normalizedValue.trim(),STRIP_QUOTE_PATTERN.test(normalizedValue)&&(normalizedValue=normalizedValue.substring(1,normalizedValue.length-1))),result.hasOwnProperty(name)?(result[name]=Array.isArray(result[name])?result[name]:[result[name]],result[name].push(normalizedValue)):result[name]=normalizedValue}),uf.length>args.length&&uf.slice(args.length).forEach((flag,i)=>{let name="unknown"+(i+1);for(;result.hasOwnProperty(name);){const number=name.substring(7);name="unknown"+(parseInt(number)+1)}result[name]=flag}),result}}}),Object.defineProperty(data.help,"default",{enumerable:!0,get:()=>this.help}),data}async run(input,callback){const fn=(_classPrivateFieldGet(this,_fn)||this.defaultHandler).bind(this),data="string"==typeof input?this.parse(input):input;if(arguments[0]=this.deepParse(input),arguments[0].plugins=this.plugins,null!==this.shell){const parentMiddleware=this.shell.getCommandMiddleware(this.commandroot.replace(new RegExp("^"+this.shell.name,"i"),"").trim());parentMiddleware.length>0&&this.middleware.use(...parentMiddleware)}const trailers=this.trailers;return arguments[0].help&&arguments[0].help.requested?(console.log(this.help),void(trailers.size>0&&trailers.run(arguments[0]))):this.middleware.size>0?(this.middleware.run(arguments[0],async meta=>await Command.reply(fn(meta,callback))),void(trailers.size>0&&trailers.run(arguments[0]))):(data.plugins=this.plugins,Command.reply(fn(data,callback)),void(trailers.size>0&&trailers.run(arguments[0])))}static stderr(err){return Error,new Promise((resolve,reject)=>reject(err)).catch(console.error)}static reply(callback){return new Promise((resolve,reject)=>{try{"function"==typeof callback&&callback(),resolve()}catch(e){reject(e)}})}}const all={Shell:Shell,Command:Command,Formatter:Formatter,Table:Table,Middleware:Middleware};export default all;export{Command,Formatter,Middleware,Shell};
//# sourceMappingURL=../shell-debug/index.js.map
